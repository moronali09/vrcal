<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Link Player</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{max-width:900px;margin:18px auto;padding:18px;gap:12px;display:flex;flex-direction:column}
    header{display:flex;gap:8px;align-items:center}
    textarea,input,button,select{font-size:15px;padding:8px;border:1px solid #ddd;border-radius:8px}
    textarea{width:100%;height:80px;resize:vertical}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    video{width:100%;height:auto;background:#000;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.08)}
    .row{display:flex;gap:8px;align-items:center}
    .list{display:flex;flex-direction:column;gap:6px}
    .item{padding:8px;border-radius:8px;background:#f6f7fb;cursor:pointer}
    footer{font-size:13px;color:#666}
    .small{font-size:13px;color:#444}
  </style>
</head>
<body>
  <header>
    <input id="singleInput" placeholder="Enter your link(s) â€” one per line" style="flex:1">
    <button id="loadBtn">Load</button>
  </header>
  <div class="controls">
    <textarea id="multiInput" placeholder="Or paste multiple video links here, one per line"></textarea>
    <div style="min-width:220px;display:flex;flex-direction:column;gap:8px">
      <div class="row">
        <input id="dubbUrl" placeholder="Dubbing audio URL (mp3)" style="flex:1">
        <button id="addDubb">Add Dubbing</button>
      </div>
      <select id="dubbSelect">
        <option value="original">Original audio</option>
      </select>
      <label class="small">Volume <input id="vol" type="range" min="0" max="1" step="0.01" value="1"></label>
      <label class="small"><input id="autonext" type="checkbox"> Auto-play next</label>
    </div>
  </div>
  <video id="video" controls crossorigin playsinline></video>
  <div style="display:flex;gap:12px;align-items:flex-start">
    <div style="flex:1">
      <div class="small">Playlist</div>
      <div id="playlist" class="list"></div>
    </div>
    <div style="width:260px">
      <div class="small">Dubbing tracks</div>
      <div id="dubbList" class="list"></div>
    </div>
  </div>
  <footer>Drop video links (mp4, m3u8 if browser supports) top. Add an external audio URL to use as dubbing; the player will mute original and play the dubbing synced. Deploy this single file on Vercel.</footer>
  <script>
    const video = document.getElementById('video')
    const singleInput = document.getElementById('singleInput')
    const multiInput = document.getElementById('multiInput')
    const loadBtn = document.getElementById('loadBtn')
    const playlistEl = document.getElementById('playlist')
    const dubbUrl = document.getElementById('dubbUrl')
    const addDubb = document.getElementById('addDubb')
    const dubbSelect = document.getElementById('dubbSelect')
    const dubbList = document.getElementById('dubbList')
    const vol = document.getElementById('vol')
    const autonext = document.getElementById('autonext')
    let playlist = []
    let currentIndex = -1
    const dubbings = []
    const audio = new Audio()
    audio.crossOrigin = 'anonymous'
    function renderPlaylist(){
      playlistEl.innerHTML = ''
      playlist.forEach((u,i)=>{
        const el = document.createElement('div')
        el.className = 'item'
        el.textContent = (i+1)+'. '+u
        el.onclick = ()=>{loadIndex(i)}
        playlistEl.appendChild(el)
      })
    }
    function renderDubbings(){
      dubbList.innerHTML = ''
      dubbSelect.innerHTML = ''
      const opt = document.createElement('option')
      opt.value = 'original'
      opt.textContent = 'Original audio'
      dubbSelect.appendChild(opt)
      dubbings.forEach((d,i)=>{
        const el = document.createElement('div')
        el.className = 'item'
        el.textContent = d.name || d.url
        el.onclick = ()=>{dubbSelect.value = 'd'+i; dubbSelect.dispatchEvent(new Event('change'))}
        dubbList.appendChild(el)
        const o = document.createElement('option')
        o.value = 'd'+i
        o.textContent = d.name || d.url
        dubbSelect.appendChild(o)
      })
    }
    function loadIndex(i){
      if(i<0||i>=playlist.length) return
      currentIndex = i
      video.src = playlist[i]
      video.load()
      video.play().catch(()=>{})
    }
    loadBtn.addEventListener('click',()=>{
      const s = singleInput.value.trim()
      const m = multiInput.value.trim()
      let urls = []
      if(s) urls = urls.concat(s.split(/\r?\n/).map(x=>x.trim()).filter(Boolean))
      if(m) urls = urls.concat(m.split(/\r?\n/).map(x=>x.trim()).filter(Boolean))
      if(urls.length===0) return
      playlist = urls
      renderPlaylist()
      loadIndex(0)
    })
    addDubb.addEventListener('click',()=>{
      const u = dubbUrl.value.trim()
      if(!u) return
      dubbings.push({url:u,name:u.split('/').pop()})
      dubbUrl.value=''
      renderDubbings()
    })
    dubbSelect.addEventListener('change',async ()=>{
      const v = dubbSelect.value
      if(v==='original'){
        audio.pause()
        audio.src = ''
        video.muted = false
        return
      }
      const idx = parseInt(v.slice(1))
      if(Number.isNaN(idx)) return
      const d = dubbings[idx]
      audio.src = d.url
      try{
        audio.currentTime = Math.max(0,video.currentTime)
      }catch(e){}
      video.muted = true
      audio.volume = Number(vol.value)
      await audio.play().catch(()=>{})
    })
    video.addEventListener('play',()=>{
      if(audio.src){
        audio.play().catch(()=>{})
      }
    })
    video.addEventListener('pause',()=>{
      if(audio.src) audio.pause()
    })
    video.addEventListener('seeked',()=>{
      if(audio.src){
        try{audio.currentTime = video.currentTime}catch(e){}
      }
    })
    video.addEventListener('timeupdate',()=>{
      if(audio.src){
        const a = audio.currentTime
        const v = video.currentTime
        if(Math.abs(a - v) > 0.35){
          try{audio.currentTime = v}catch(e){}
        }
      }
    })
    video.addEventListener('ended',()=>{
      if(autonext.checked && currentIndex+1<playlist.length){
        loadIndex(currentIndex+1)
      } else if(audio.src){
        audio.pause()
      }
    })
    vol.addEventListener('input',()=>{
      const val = Number(vol.value)
      video.volume = val
      audio.volume = val
    })
  </script>
</body>
</html>
